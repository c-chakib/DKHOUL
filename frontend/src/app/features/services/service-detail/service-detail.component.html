<div class="service-detail-container" *ngIf="!loading && service">
  <!-- Image Gallery -->
  <div class="gallery-section">
    <div class="main-image" *ngIf="service.images?.length > 0; else noImage">
      <img [src]="service.images[selectedImage]" [alt]="service.title">
      <div class="gallery-navigation">
        <button mat-icon-button class="nav-btn prev" (click)="selectImage((selectedImage - 1 + service.images.length) % service.images.length)" *ngIf="service.images.length > 1">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button mat-icon-button class="nav-btn next" (click)="selectImage((selectedImage + 1) % service.images.length)" *ngIf="service.images.length > 1">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    <ng-template #noImage>
      <div class="main-image placeholder">
        <div class="placeholder-icon" aria-label="No image available">
          <mat-icon>image_not_supported</mat-icon>
        </div>
      </div>
    </ng-template>
    <div class="thumbnail-strip" *ngIf="service.images.length > 1">
      <div class="thumbnail" 
           *ngFor="let image of service.images; let i = index" 
           [class.active]="i === selectedImage"
           (click)="selectImage(i)">
        <img [src]="image" [alt]="service.title + ' - Image ' + (i + 1)">
      </div>
    </div>
  </div>

  <div class="content-wrapper">
    <!-- Main Content -->
    <div class="main-content">
      <!-- Service Header -->
      <div class="service-header">
        <div class="header-top">
          <span class="category-badge" [class]="(service?.category || 'uncategorized').toLowerCase()">
            {{ service?.category || 'Uncategorized' }}
          </span>
          <button mat-icon-button (click)="shareService()" matTooltip="Share Service">
            <mat-icon>share</mat-icon>
          </button>
        </div>
        <h1>{{ service.title }}</h1>
        <div class="meta-info">
          <div class="rating">
            <mat-icon *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= (service?.averageRating || 0)">star</mat-icon>
            <span class="rating-text">{{ (service?.averageRating || 0) | number:'1.1-1' }} ({{ service.reviews?.length || 0 }} reviews)</span>
          </div>
          <div class="location">
            <mat-icon>location_on</mat-icon>
            <span>{{ service.location?.city || 'Unknown City' }}, {{ service.location?.region || 'Unknown Region' }}</span>
          </div>
        </div>
      </div>

      <!-- Description -->
      <mat-card class="description-card">
        <mat-card-header>
          <mat-card-title>About This Service</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p>{{ service.description }}</p>
        </mat-card-content>
      </mat-card>

      <!-- Amenities -->
      <mat-card class="amenities-card" *ngIf="service.amenities && service.amenities.length > 0">
        <mat-card-header>
          <mat-card-title>What's Included</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="amenities-grid">
            <div class="amenity-item" *ngFor="let amenity of service.amenities">
              <mat-icon>check_circle</mat-icon>
              <span>{{ amenity }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Host Information -->
      <mat-card class="host-card">
        <mat-card-header>
          <div class="host-avatar">
            <img [src]="service.host?.photo || 'assets/default-avatar.svg'" [alt]="service.host?.fullName">
          </div>
          <div class="host-info">
            <mat-card-title>Hosted by {{ service.host?.fullName }}</mat-card-title>
            <mat-card-subtitle>Member since {{ service.host?.createdAt | date: 'MMM yyyy' }}</mat-card-subtitle>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="host-stats">
            <div class="stat">
              <mat-icon>star</mat-icon>
              <span>{{ service.host?.averageRating?.toFixed(1) || 'N/A' }} Rating</span>
            </div>
            <div class="stat">
              <mat-icon>verified</mat-icon>
              <span>{{ service.host?.isVerified ? 'Verified' : 'Not Verified' }}</span>
            </div>
            <div class="stat">
              <mat-icon>language</mat-icon>
              <span>{{ service.host?.languages?.join(', ') || 'Not specified' }}</span>
            </div>
          </div>
          <button mat-raised-button color="primary" (click)="contactHost()" *ngIf="!isHost">
            <mat-icon>message</mat-icon>
            Contact Host
          </button>
        </mat-card-content>
      </mat-card>

      <!-- Reviews Section -->
      <mat-card class="reviews-card" *ngIf="service.reviews && service.reviews.length > 0">
        <mat-card-header>
          <mat-card-title>Reviews ({{ service.reviews.length }})</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Rating Overview -->
          <div class="rating-overview">
            <div class="overall-rating">
              <h2>{{ service.averageRating.toFixed(1) }}</h2>
              <div class="stars">
                <mat-icon *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= service.averageRating">star</mat-icon>
              </div>
            </div>
            <div class="rating-breakdown">
              <div class="rating-bar" *ngFor="let stat of reviewStats()">
                <span class="stars-label">{{ stat.stars }} stars</span>
                <div class="bar">
                  <div class="fill" [style.width.%]="stat.percentage"></div>
                </div>
                <span class="percentage">{{ stat.percentage }}%</span>
              </div>
            </div>
          </div>

          <!-- Review List -->
          <div class="reviews-list">
            <div class="review-item" *ngFor="let review of service.reviews">
              <div class="review-header">
                <div class="reviewer-info">
                  <img [src]="review.user?.photo || 'assets/default-avatar.svg'" [alt]="review.user?.fullName" class="reviewer-avatar">
                  <div>
                    <h4>{{ review.user?.fullName }}</h4>
                    <p class="review-date">{{ review.createdAt | date: 'MMM d, yyyy' }}</p>
                  </div>
                </div>
                <div class="review-rating">
                  <mat-icon *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= review.overallRating">star</mat-icon>
                </div>
              </div>
              <p class="review-text">{{ review.comment }}</p>
              <div class="host-response" *ngIf="review.response">
                <h5>Host Response:</h5>
                <p>{{ review.response }}</p>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Location Map -->
      <mat-card class="map-card">
        <mat-card-header>
          <mat-card-title>Location</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="map-placeholder">
            <mat-icon>location_on</mat-icon>
            <p>{{ service.location?.address || 'Unknown address' }}, {{ service.location?.city || 'Unknown City' }}, {{ service.location?.region || 'Unknown Region' }}</p>
            <small>Map integration coming soon</small>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Booking Sidebar -->
    <div class="booking-sidebar">
      <mat-card class="booking-card">
        <mat-card-content>
          <div class="price-section">
            <span class="price">{{ service.pricing?.amount || 0 }} MAD</span>
            <span class="price-unit">/ {{ service.pricing?.type === 'per_hour' ? 'hour' : service.pricing?.type === 'per_day' ? 'day' : 'service' }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="booking-info">
            <div class="info-row">
              <mat-icon>schedule</mat-icon>
              <span>Available: {{ service.availability?.days?.join(', ') || 'Contact host' }}</span>
            </div>
            <div class="info-row" *ngIf="service.maxGuests">
              <mat-icon>people</mat-icon>
              <span>Max {{ service.maxGuests }} guests</span>
            </div>
            <div class="info-row" *ngIf="service.duration">
              <mat-icon>timer</mat-icon>
              <span>{{ service.duration }} minutes</span>
            </div>
          </div>

          <button mat-raised-button color="accent" class="book-button" (click)="bookService()" *ngIf="!isHost">
            <mat-icon>event_available</mat-icon>
            Book Now
          </button>

          <button mat-raised-button color="primary" class="edit-button" routerLink="/services/edit/{{ service._id }}" *ngIf="isHost">
            <mat-icon>edit</mat-icon>
            Edit Service
          </button>

          <p class="booking-note">You won't be charged yet</p>
        </mat-card-content>
      </mat-card>

      <!-- Host Quick Info -->
      <mat-card class="quick-info-card">
        <mat-card-content>
          <div class="quick-info-item">
            <mat-icon>verified_user</mat-icon>
            <div>
              <strong>Verified Host</strong>
              <p>Identity confirmed</p>
            </div>
          </div>
          <div class="quick-info-item">
            <mat-icon>cancel</mat-icon>
            <div>
              <strong>Free Cancellation</strong>
              <p>Cancel within 24h</p>
            </div>
          </div>
          <div class="quick-info-item">
            <mat-icon>support_agent</mat-icon>
            <div>
              <strong>24/7 Support</strong>
              <p>Always here to help</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <mat-spinner></mat-spinner>
  <p>Loading service details...</p>
</div>
